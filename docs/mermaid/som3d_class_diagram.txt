classDiagram
    %% =====================
    %% CAPA DE USUARIOS / CLÍNICA / NEGOCIO
    %% =====================

    class Hospital {
        <<Entidad>>
        +id_hospital: int
        +nombre: varchar
        +direccion: varchar?
        +ciudad: varchar?
        +telefono: varchar?
        +correo: varchar?
        +codigo: varchar
        +estado: enum(ACTIVO,INACTIVO)
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class Usuario {
        <<Entidad>>
        +id_usuario: int
        +nombre: varchar
        +apellido: varchar
        +correo: varchar
        +contrasena: varchar
        +telefono: varchar?
        +direccion: varchar?
        +ciudad: varchar?
        +rol: enum(ADMINISTRADOR,MEDICO)
        +activo: bool
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class Medico {
        <<Entidad>>
        +id_medico: int
        +id_usuario: int
        +id_hospital: int?
        +referenciado: bool
        +estado: enum(ACTIVO,INACTIVO)
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class Paciente {
        <<Entidad>>
        +id_paciente: int
        +id_medico: int
        +doc_tipo: varchar?
        +doc_numero: varchar?
        +nombres: varchar
        +apellidos: varchar
        +fecha_nacimiento: date?
        +sexo: varchar?
        +telefono: varchar?
        +correo: varchar?
        +direccion: varchar?
        +ciudad: varchar?
        +estado: enum(ACTIVO,INACTIVO)
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class Estudio {
        <<Entidad>>
        +id_estudio: int
        +id_paciente: int
        +id_medico: int
        +modalidad: varchar?
        +fecha_estudio: datetime
        +descripcion: varchar?
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class JobConv {
        <<Entidad>>
        +job_id: varchar  // PK lógico
        +id_usuario: int
        +status: enum(QUEUED,RUNNING,DONE,ERROR,CANCELED)
        +enable_ortopedia: bool
        +enable_appendicular: bool
        +enable_muscles: bool
        +enable_skull: bool
        +enable_teeth: bool
        +enable_hip_implant: bool
        +extra_tasks_json: text?
        +queue_name: varchar?
        +started_at: datetime?
        +finished_at: datetime?
        +updated_at: timestamp
    }

    class JobSTL {
        <<Entidad>>
        +id_jobstl: int
        +job_id: varchar     // FK -> JobConv.job_id
        +id_paciente: int
        +stl_size: bigint?
        +num_stl_archivos: int?
        +created_at: timestamp
        +updated_at: timestamp
    }

    class Plan {
        <<Entidad>>
        +id_plan: int
        +nombre: varchar
        +precio: decimal(12,2)
        +periodo: enum(MENSUAL,TRIMESTRAL,ANUAL)
        +duracion_meses: int
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class Suscripcion {
        <<Entidad>>
        +id_suscripcion: int
        +id_medico: int?
        +id_hospital: int?
        +id_plan: int
        +fecha_inicio: datetime
        +fecha_expiracion: datetime?
        +estado: enum(ACTIVA,PAUSADA)
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class Pago {
        <<Entidad>>
        +id_pago: int
        +id_suscripcion: int
        +referencia_epayco: varchar
        +monto: decimal(12,2)
        +fecha_pago: datetime
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class VisorEstado {
        <<Entidad>>
        +id_visor_estado: int
        +id_medico: int
        +id_paciente: int
        +id_jobstl: int?
        +titulo: varchar
        +descripcion: varchar?
        +ui_json: text
        +modelos_json: text
        +notas_json: text
        +i18n_json: text
        +creado_en: timestamp
        +actualizado_en: timestamp
    }

    class Mensaje {
        <<Entidad>>
        +id_mensaje: int
        +id_medico: int
        +id_paciente: int?
        +tipo: varchar       // 'error' | 'sugerencia'
        +titulo: varchar
        +descripcion: text
        +severidad: varchar  // 'baja' | 'media' | 'alta'
        +adjunto_url: varchar?
        +estado: varchar = "nuevo"
        +respuesta_admin: text?
        +leido_admin: bool
        +leido_medico: bool
        +creado_en: datetime(tz)
        +actualizado_en: datetime(tz)
    }

    %% =====================
    %% CAPA PIPELINE SOM3D / PROCESAMIENTO TÉCNICO
    %% =====================

    class TotalSegmentatorRunner {
        <<ServicioPipeline>>
        - robust_import: bool
        - enable_ortopedia: bool
        - enable_appendicular: bool
        - enable_muscles: bool
        - enable_hip_implant: bool
        - extra_tasks: List~str~
        - on_log: Callable
        - dev_info: Dict
        - _license_checked: bool
        + __init__(...)
        + run(input_path: Path, output_path: Path) float
        - _ensure_license()
        - _robust_dicom_to_nifti(...)
        - _run_totalseg_gpu_then_cpu(...)
        - _merge_and_cleanup_stats(...)
        - _postprocess_cranio_outputs(...)
    }

    class NiftiToSTLConverter {
        <<ServicioPipeline>>
        + __init__(progress_cb=None)
        + convert_folder(input_dir, output_dir, ...)
        + convert_file(nifti_path, output_dir, ...)
        - _log(msg)
    }

    class S3Config {
        <<dataclass>>
        + endpoint: str?
        + insecure: bool
        + bucket: str
        + prefix: str
        + region: str
        + access_key: str?
        + secret_key: str?
        + __post_init__()
    }

    class S3Manager {
        <<Infra>>
        + __init__(cfg: S3Config)
        + ensure_bucket()
        + upload_file(local_path, key)
        + upload_bytes(data, key, content_type?)
        + download_bytes(key) bytes
        + exists(key) bool
        + list(prefix?) List~str~
        + list_meta(prefix?) List~Dict~
        + presign_get(key, expires=3600) str
        - _norm(*parts) str
        + join_key(prefix?, *parts) str
    }

    class JobManifest {
        <<dataclass>>
        + job_id: str
        + created_at: float
        + updated_at: float
        + status: str         // queued|running|done|error|canceled
        + phase: str          // queued|totalsegmentator|converting|zipping|finished|error|canceled
        + percent: float
        + params: Dict
        + metrics: Dict
        + error: str?
        + log_tail: List~str~?
        + bucket: str?
        + s3_prefix: str?
        + s3_keys_results: List~str~?
        + to_dict() Dict
    }

    %% =====================
    %% RELACIONES DEL DOMINIO
    %% =====================

    Usuario "1" -- "1" Medico : "credenciales / perfil"
    Hospital "1" -- "many" Medico : "afiliado a"
    Medico "1" -- "many" Paciente : "atiende"
    Paciente "1" -- "many" Estudio : "es objeto de"
    Medico "1" -- "many" Estudio : "ordena"

    Usuario "1" -- "many" JobConv : "lanza pipeline"
    JobConv "1" -- "many" JobSTL : "genera"
    Paciente "1" -- "many" JobSTL : "resultados para"

    Plan "1" -- "many" Suscripcion : "ofrece"
    Medico "1" -- "many" Suscripcion : "suscribe"
    Hospital "1" -- "many" Suscripcion : "suscribe"
    Suscripcion "1" -- "many" Pago : "pagos"

    Medico "1" -- "many" VisorEstado : "crea"
    Paciente "1" -- "many" VisorEstado : "visualiza"
    JobSTL "1" -- "many" VisorEstado : "usa"

    Medico "1" -- "many" Mensaje : "emite"
    Paciente "1" -- "many" Mensaje : "relacionado"

    %% =====================
    %% RELACIONES PIPELINE / INFRA
    %% =====================

    S3Manager o-- S3Config : "usa cfg"
    JobManifest ..> S3Manager : "sube/lee artefactos"
    TotalSegmentatorRunner ..> JobManifest : "actualiza estado/fase"
    NiftiToSTLConverter ..> JobManifest : "registra métricas STL"

    %% =====================
    %% PUENTE ENTRE NEGOCIO Y PIPELINE
    %% =====================

    JobConv "1" -- "1" JobManifest : "tracking runtime (estado,fase,logs,S3)"
