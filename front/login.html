<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3DVinci Health — Acceso</title>

    <!-- Tailwind sin preflight -->
    <script>
      window.tailwind = { config: { corePlugins: { preflight: false } } };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet"/>

    <style>
      :root { color-scheme: dark; }
      .glass { background: rgba(17,24,39,.7); backdrop-filter: blur(8px); }
      .hint { font-size:.78rem }
      .badge { font-size:.7rem; padding:.15rem .45rem; border-radius:.5rem }
      /* ePayco puede inyectar un botón extra de texto */
      .btn-epayco { display:none !important; }
    </style>
  </head>

  <body class="min-h-screen bg-black text-white font-['Roboto'] flex items-center justify-center p-6">
    <!-- Toast -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 hidden">
      <div class="px-4 py-2 rounded-xl bg-gray-900/90 border border-gray-700 shadow-lg text-sm"></div>
    </div>

    <div class="w-full max-w-4xl glass rounded-3xl shadow-2xl p-6 md:p-10 border border-gray-800">
      <!-- Header -->
      <div class="mb-8 flex items-center justify-between gap-4">
        <h1 class="text-2xl md:text-3xl font-bold tracking-wide">
          <span class="text-cyan-400">3DVinci</span> Health
        </h1>
      </div>

      <!-- Tabs -->
      <div class="grid grid-cols-2 gap-2 mb-8">
        <button id="tab-login" class="py-3 rounded-xl font-semibold bg-cyan-500 text-black hover:bg-cyan-400 transition">Ingresar</button>
        <button id="tab-register" class="py-3 rounded-xl font-semibold bg-gray-800 text-gray-100 border border-gray-700 hover:border-cyan-400 transition">Crear cuenta</button>
      </div>

      <!-- Panel: Login -->
      <div id="panel-login">
        <div class="w-full max-w-lg mx-auto bg-gray-900 rounded-2xl shadow-xl p-6 border border-gray-800">
          <div class="mb-6 text-center">
            <h2 class="text-2xl font-bold">Acceso Médico</h2>
            <p class="text-sm text-gray-400 mt-1">Ingresa con tu correo y contraseña.</p>
          </div>

          <form id="form-login" class="space-y-5" novalidate>
            <div>
              <label for="login-email" class="block text-sm font-semibold text-gray-300 mb-2">Correo electrónico</label>
              <input
                type="email" id="login-email" placeholder="doctor@hospital.com"
                class="w-full py-3 px-3 bg-black border border-gray-700 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 text-white placeholder-gray-500" required />
              <p id="login-email-err" class="hint text-red-400 mt-1 hidden">Ingresa un correo válido.</p>
            </div>

            <div>
              <label for="login-password" class="block text-sm font-semibold text-gray-300 mb-2">Contraseña</label>
              <input
                type="password" id="login-password" placeholder="********" minlength="6"
                class="w-full py-3 px-3 bg-black border border-gray-700 rounded-lg focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 text-white placeholder-gray-500" required />
              <p id="login-pass-err" class="hint text-red-400 mt-1 hidden">La contraseña debe tener al menos 6 caracteres.</p>
            </div>

            <div class="flex flex-col gap-3">
              <button id="login-submit" type="submit" class="w-full px-4 py-3 rounded-xl bg-cyan-500 text-black font-semibold hover:bg-cyan-400 transition disabled:opacity-50 disabled:cursor-not-allowed">Ingresar</button>
              <a href="#" class="text-sm text-cyan-400 hover:text-cyan-300 text-center">Olvidé mi contraseña</a>
            </div>
          </form>
        </div>
      </div>

      <!-- Panel: Registro -->
      <div id="panel-register" class="hidden">
        <!-- Steps -->
        <div class="flex justify-between items-center relative mb-8">
          <div class="absolute top-1/2 left-0 w-full border-t border-gray-700 -z-0"></div>
          <div class="relative z-10 flex flex-col items-center">
            <div id="ind-1" class="w-10 h-10 flex items-center justify-center rounded-full bg-cyan-500 text-black font-bold">1</div>
            <span id="txt-1" class="mt-2 text-cyan-400 font-semibold">Plan</span>
          </div>
          <div class="relative z-10 flex flex-col items-center">
            <div id="ind-2" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-700 text-gray-300 font-bold">2</div>
            <span id="txt-2" class="mt-2 text-gray-400 font-semibold">Datos</span>
          </div>
          <div class="relative z-10 flex flex-col items-center">
            <div id="ind-3" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-700 text-gray-300 font-bold">3</div>
            <span id="txt-3" class="mt-2 text-gray-400 font-semibold">Verificar</span>
          </div>
          <div class="relative z-10 flex flex-col items-center">
            <div id="ind-4" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-700 text-gray-300 font-bold">4</div>
            <span id="txt-4" class="mt-2 text-gray-400 font-semibold">Pago</span>
          </div>
        </div>

        <!-- Step 1: Plan -->
        <div id="reg-step1" class="space-y-6">
          <h2 class="text-2xl font-bold text-cyan-400 text-center">Selecciona tu plan</h2>
          <div id="plans-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
          <button id="reg-next1" class="w-full py-3 rounded-xl bg-cyan-500 text-black font-bold hover:bg-cyan-400 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Siguiente →</button>
        </div>

        <!-- Step 2: Datos -->
        <div id="reg-step2" class="space-y-6 hidden">
          <h2 class="text-2xl font-bold text-cyan-400 text-center">Datos de usuario</h2>

          <form id="form-register" class="bg-gray-900 p-6 rounded-2xl shadow-inner border border-gray-800" novalidate>
            <!-- Rol fijo -->
            <input type="hidden" id="reg-rol" name="rol" value="MEDICO" />

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Nombre / Apellido -->
              <label class="text-sm text-gray-300">Nombre
                <input id="reg-nombre" minlength="2" required class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg" />
                <small id="err-nombre" class="hint text-red-400 hidden">Mínimo 2 caracteres.</small>
              </label>

              <label class="text-sm text-gray-300">Apellido
                <input id="reg-apellido" minlength="2" required class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg" />
                <small id="err-apellido" class="hint text-red-400 hidden">Mínimo 2 caracteres.</small>
              </label>

              <!-- Ciudad / Teléfono -->
              <label class="text-sm text-gray-300">Ciudad
                <select id="reg-ciudad" required class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg bg-black">
                  <option value="">Selecciona ciudad</option>
                  <option value="Bogotá">Bogotá</option>
                  <option value="Medellín">Medellín</option>
                  <option value="Cali">Cali</option>
                  <option value="Barranquilla">Barranquilla</option>
                  <option value="Cartagena">Cartagena</option>
                  <option value="Cúcuta">Cúcuta</option>
                  <option value="Bucaramanga">Bucaramanga</option>
                  <option value="Pereira">Pereira</option>
                  <option value="Santa Marta">Santa Marta</option>
                  <option value="Ibagué">Ibagué</option>
                  <option value="Villavicencio">Villavicencio</option>
                  <option value="Pasto">Pasto</option>
                  <option value="Manizales">Manizales</option>
                  <option value="Montería">Montería</option>
                  <option value="Neiva">Neiva</option>
                  <option value="Popayán">Popayán</option>
                  <option value="Armenia">Armenia</option>
                  <option value="Sincelejo">Sincelejo</option>
                  <option value="Valledupar">Valledupar</option>
                  <option value="Tunja">Tunja</option>
                  <option value="Riohacha">Riohacha</option>
                  <option value="Florencia">Florencia</option>
                  <option value="Yopal">Yopal</option>
                  <option value="Arauca">Arauca</option>
                  <option value="Quibdó">Quibdó</option>
                  <option value="Mocoa">Mocoa</option>
                  <option value="San Andrés">San Andrés</option>
                  <option value="Leticia">Leticia</option>
                  <option value="Otro">Otro</option>
                </select>
              </label>

              <label class="text-sm text-gray-300">Teléfono
                <input id="reg-telefono" inputmode="numeric" pattern="^[0-9]{7,15}$" required class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg" placeholder="7-15 dígitos" />
                <small id="err-telefono" class="hint text-red-400 hidden">Debe tener entre 7 y 15 dígitos.</small>
              </label>

              <!-- Dirección / Código hospital (misma fila) -->
              <label class="text-sm text-gray-300">Dirección
                <input id="reg-direccion" required class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg" />
              </label>

              <label class="text-sm text-gray-300">Código de hospital
                <input id="reg-hospital-codigo" maxlength="12" pattern="^[A-Za-z0-9-]{1,12}$" class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg" placeholder="Opcional (ej.: HSP-001)" />
                <small id="err-hospcod" class="hint text-gray-400">Único campo opcional.</small>
              </label>

              <!-- Correo (campo largo, 2 columnas) -->
              <label class="text-sm text-gray-300 md:col-span-2">Correo
                <input id="reg-correo" type="email" required class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg" />
                <small id="err-correo" class="hint text-red-400 hidden">Correo no válido.</small>
              </label>

              <!-- Contraseña / Repetir contraseña -->
              <label class="text-sm text-gray-300">Contraseña
                <input id="reg-password" type="password" minlength="8" required class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg" placeholder="≥ 8 caracteres, 1 número y 1 letra" />
                <div class="flex items-center gap-2 mt-1">
                  <div id="pwd-meter" class="h-1 w-full bg-gray-800 rounded overflow-hidden">
                    <div id="pwd-bar" class="h-1 w-0 bg-red-500 transition-all"></div>
                  </div>
                  <span id="pwd-badge" class="badge bg-red-500/20 text-red-300">Débil</span>
                </div>
                <small class="hint text-gray-400">Requisitos: mínimo 8 caracteres, al menos 1 número y 1 letra.</small>
                <small id="err-pass" class="hint text-red-400 hidden">La contraseña no cumple los requisitos.</small>
              </label>

              <label class="text-sm text-gray-300">Repetir contraseña
                <input id="reg-password2" type="password" minlength="8" required class="mt-1 w-full py-2.5 px-3 bg-black border border-gray-700 rounded-lg" placeholder="Repite la contraseña" />
                <small id="err-pass2" class="hint text-red-400 hidden">Las contraseñas no coinciden.</small>
              </label>
            </div>

            <!-- Botones -->
            <div class="flex justify-between mt-6">
              <button id="reg-back1" type="button" class="px-6 py-3 rounded-xl bg-gray-800 text-white font-semibold hover:bg-gray-700 border border-gray-700 transition">← Atrás</button>
              <button id="reg-next2" type="button" class="px-6 py-3 rounded-xl bg-cyan-500 text-black font-bold hover:bg-cyan-400 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>Siguiente →</button>
            </div>

            <p class="sr-only" aria-live="polite" id="reg-live"></p>
          </form>
        </div>

        <!-- Step 3: Verificar correo -->
        <div id="reg-step3" class="space-y-6 hidden">
          <h2 class="text-2xl font-bold text-cyan-400 text-center">Verifica tu correo</h2>
          <div class="bg-gray-900 p-6 rounded-2xl shadow-inner border border-gray-800">
            <p class="text-gray-300 text-center">Te enviamos un email con un enlace de verificación. Ábrelo para confirmar tu cuenta.</p>
            <p id="verify-to" class="text-gray-400 text-center mt-2 text-sm"></p>
            <div class="flex flex-wrap gap-3 justify-center mt-4">
              <button id="verify-resend" class="px-6 py-3 rounded-xl bg-gray-800 text-white font-semibold hover:bg-gray-700 border border-gray-700 transition">Reenviar correo</button>
              <button id="verify-continue" class="px-6 py-3 rounded-xl bg-cyan-500 text-black font-bold hover:bg-cyan-400 transition">Ya verifiqué</button>
              <button id="reg-back2" class="px-6 py-3 rounded-xl bg-gray-800 text-white font-semibold hover:bg-gray-700 border border-gray-700 transition">Atrás</button>
            </div>
          </div>
        </div>

        <!-- Step 4: Pago -->
        <div id="reg-step4" class="space-y-6 hidden">
          <h2 class="text-2xl font-bold text-cyan-400 text-center">Pago con ePayco</h2>
          <div class="bg-gray-900 p-6 rounded-2xl shadow-inner border border-gray-800">
            <p class="text-gray-400 mb-4 text-center">Procesa el pago para activar tu suscripción.</p>
            <div class="flex justify-center">
              <form id="epayco-form"></form>
            </div>
          </div>
          <div class="flex flex-wrap gap-3 justify-center">
            <button id="reg-back3" class="px-6 py-3 rounded-xl bg-gray-800 text-white font-semibold hover:bg-gray-700 border border-gray-700 transition">← Atrás</button>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="mt-10 text-center text-xs text-gray-500">
        © <span id="y"></span> 3DVinci Health — All rights reserved.
      </div>
    </div>

    <!-- ===== JS ===== -->
    <script>
      // ========= Utils =========
      const qs = (s, el = document) => el.querySelector(s);
      const qsa = (s, el = document) => [...el.querySelectorAll(s)];
      const setHidden = (el, h) => el.classList.toggle("hidden", h);
      const show = (el, flag) => el.classList.toggle("hidden", !flag);
      const setDisabled = (el, flag) => {
        el.disabled = !!flag;
        el.classList.toggle("opacity-50", !!flag);
        el.classList.toggle("cursor-not-allowed", !!flag);
      };
      qs("#y").textContent = new Date().getFullYear();

      // Toast
      const toastBox = qs("#toast");
      function toast(msg, type = "info") {
        const box = toastBox.firstElementChild;
        box.textContent = msg;
        box.className =
          "px-4 py-2 rounded-xl shadow-lg text-sm border " +
          (type === "ok"
            ? "bg-emerald-900/80 border-emerald-700"
            : type === "err"
              ? "bg-rose-900/80 border-rose-700"
              : "bg-gray-900/90 border-gray-700");
        toastBox.classList.remove("hidden");
        setTimeout(() => toastBox.classList.add("hidden"), 2400);
      }

      // ========= API =========
      let API_BASE = localStorage.getItem("API_BASE") || "http://localhost:8000";
      let TOKEN = localStorage.getItem("jwt") || null;

      async function api(path, { method = "GET", headers = {}, body } = {}) {
        const t = localStorage.getItem("jwt") || TOKEN;
        const res = await fetch(API_BASE + path, {
          method,
          headers: {
            "Content-Type": "application/json",
            ...(t ? { Authorization: "Bearer " + t } : {}),
            ...headers,
          },
          body: body ? JSON.stringify(body) : undefined,
        });
        const text = await res.text();
        let data;
        try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
        if (!res.ok) {
          const err = new Error(data?.detail || "HTTP " + res.status);
          err.status = res.status;
          err.data = data;
          throw err;
        }
        return data;
      }

      // ========= Tabs =========
      const tabLogin = qs("#tab-login");
      const tabRegister = qs("#tab-register");
      const panelLogin = qs("#panel-login");
      const panelRegister = qs("#panel-register");

      function setTab(tab) {
        const isLogin = tab === "login";
        setHidden(panelLogin, !isLogin);
        setHidden(panelRegister, isLogin);
        tabLogin.className =
          "py-3 rounded-xl font-semibold " +
          (isLogin
            ? "bg-cyan-500 text-black hover:bg-cyan-400"
            : "bg-gray-800 text-gray-100 border border-gray-700 hover:border-cyan-400") +
          " transition";
        tabRegister.className =
          "py-3 rounded-xl font-semibold " +
          (!isLogin
            ? "bg-cyan-500 text-black hover:bg-cyan-400"
            : "bg-gray-800 text-gray-100 border border-gray-700 hover:border-cyan-400") +
          " transition";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
      tabLogin.addEventListener("click", () => setTab("login"));
      tabRegister.addEventListener("click", () => { setTab("register"); loadPlans(); });
      setTab("login");

      // ========= Validaciones =========
      const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
      const hasNum = /\d/;
      const hasLet = /[A-Za-z]/;

      function validateEmail(v) { return emailRe.test(v.trim()); }
      function validatePhone(v) { return v === "" || /^[0-9]{7,15}$/.test(v); }
      function validateHospCodigo(v) { return v === "" || /^[A-Za-z0-9-]{1,12}$/.test(v); }
      function validatePwd(v) {
        const okLen = v.length >= 8; const okNum = hasNum.test(v); const okLet = hasLet.test(v);
        return { ok: okLen && okNum && okLet, len: okLen, num: okNum, let: okLet };
      }
      function pwdStrength(v) {
        const { len, num, let: letOk } = validatePwd(v);
        let score = 0; if (len) score++; if (num) score++; if (letOk) score++;
        if (/[!@#$%^&*()_\-+=\[{\]};:'",.<>/?]/.test(v)) score++;
        return Math.min(score, 4);
      }
      function setPwdMeter(v) {
        const bar = qs("#pwd-bar");
        const badge = qs("#pwd-badge");
        const s = pwdStrength(v);
        const w = ["0%", "25%", "50%", "75%", "100%"][s];
        bar.style.width = w;
        const states = [
          { text: "Vacía", cls: "bg-gray-500/20 text-gray-300", bar: "bg-gray-700" },
          { text: "Débil", cls: "bg-red-500/20 text-red-300", bar: "bg-red-500" },
          { text: "Básica", cls: "bg-yellow-500/20 text-yellow-300", bar: "bg-yellow-500" },
          { text: "Buena", cls: "bg-emerald-500/20 text-emerald-300", bar: "bg-emerald-500" },
          { text: "Fuerte", cls: "bg-cyan-500/20 text-cyan-300", bar: "bg-cyan-500" },
        ][s];
        badge.textContent = states.text; badge.className = "badge " + states.cls;
        bar.className = "h-1 " + states.bar + " transition-all";
      }

      // ========= LOGIN =========
      const loginEmail = qs("#login-email");
      const loginPass = qs("#login-password");
      const loginBtn = qs("#login-submit");

      function validateLoginUI() {
        const eOk = validateEmail(loginEmail.value);
        const pOk = (loginPass.value || "").length >= 6;
        show(qs("#login-email-err"), !eOk && loginEmail.value !== "");
        show(qs("#login-pass-err"), !pOk && loginPass.value !== "");
        setDisabled(loginBtn, !(eOk && pOk));
        return eOk && pOk;
      }
      loginEmail.addEventListener("input", validateLoginUI);
      loginPass.addEventListener("input", validateLoginUI);
      validateLoginUI();

      // Toggle mostrar/ocultar contraseña en login
      (function addLoginPassToggle(){
        try {
          const inp = document.getElementById('login-password');
          if (!inp || !inp.parentElement) return;
          const wrap = document.createElement('div');
          wrap.className = 'relative';
          // Insert wrapper and move input inside
          const parent = inp.parentElement;
          parent.insertBefore(wrap, inp);
          wrap.appendChild(inp);
          inp.classList.add('pr-12');
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.id = 'toggle-login-pass';
          btn.className = 'absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-400 hover:text-gray-200 px-2 py-1';
          btn.textContent = 'Ver';
          wrap.appendChild(btn);
          btn.addEventListener('click', () => {
            const isPass = inp.getAttribute('type') === 'password';
            inp.setAttribute('type', isPass ? 'text' : 'password');
            btn.textContent = isPass ? 'Ocultar' : 'Ver';
          });
        } catch {}
      })();

      qs("#form-login").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!validateLoginUI()) { toast("Corrige los campos del formulario", "err"); return; }
        const correo = loginEmail.value.trim();
        const password = loginPass.value;
        setDisabled(loginBtn, true);
        try {
          const r = await api("/auth/login", { method: "POST", body: { correo, password } });
          TOKEN = r.access_token; localStorage.setItem("jwt", TOKEN);
          // Consultar perfil y decidir destino según 'activo'
          let me = null;
          try { me = await api("/auth/me"); localStorage.setItem("user", JSON.stringify(me)); } catch {}
          toast("Login exitoso. Redirigiendo…", "ok");
          if (me && me.activo === true) {
            window.location.href = "administrador.html";
          } else {
            // Usuario sin pago/activo → ir a pago
            window.location.href = "pay.html";
          }
        } catch (err) {
          toast("Error de login: " + (err?.data?.detail || err.status), "err");
          setDisabled(loginBtn, false);
        }
      });

      // ========= REGISTRO =========
      const regStep1 = qs("#reg-step1");
      const regStep2 = qs("#reg-step2");
      const regStep3 = qs("#reg-step3");
      const regStep4 = qs("#reg-step4");
      const ind1 = qs("#ind-1"), ind2 = qs("#ind-2"), ind3 = qs("#ind-3"), ind4 = qs("#ind-4");
      const txt1 = qs("#txt-1"), txt2 = qs("#txt-2"), txt3 = qs("#txt-3"), txt4 = qs("#txt-4");
      function setStep(n) {
        [regStep1, regStep2, regStep3, regStep4].forEach((el, i) => setHidden(el, i + 1 !== n));
        [[ind1, txt1], [ind2, txt2], [ind3, txt3], [ind4, txt4]].forEach(([dot, txt], i) => {
          const active = i + 1 === n;
          dot.className = "w-10 h-10 flex items-center justify-center rounded-full " + (active ? "bg-cyan-500 text-black" : "bg-gray-700 text-gray-300") + " font-bold";
          txt.className = "mt-2 font-semibold " + (active ? "text-cyan-400" : "text-gray-400");
        });
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // Planes
      const plansGrid = qs("#plans-grid");
      const next1 = qs("#reg-next1");
      let PLANS = [];
      let selectedPlanId = null;

      async function loadPlans() {
        try {
          plansGrid.innerHTML = '<div class="text-gray-400 text-sm">Cargando planes…</div>';
          PLANS = await api("/plans");
          plansGrid.innerHTML = "";
          PLANS.forEach((p) => {
            const card = document.createElement("label");
            card.className = "block p-6 bg-gray-900 border border-gray-700 rounded-2xl cursor-pointer hover:border-cyan-400 hover:shadow-lg transition";
            card.innerHTML = `
              <input type="radio" name="plan" value="${p.id_plan}" class="hidden"/>
              <span class="block text-center font-semibold text-white">${p.nombre}</span>
              <span class="block text-sm text-gray-400">$${p.precio} · ${p.periodo} (${p.duracion_meses} meses)</span>`;
            plansGrid.appendChild(card);
          });
          qsa('input[name="plan"]').forEach((r) => {
            r.addEventListener("change", () => {
              qsa('input[name="plan"]').forEach((x) => x.parentElement.classList.remove("border-cyan-400", "shadow-lg"));
              if (r.checked) { r.parentElement.classList.add("border-cyan-400", "shadow-lg"); selectedPlanId = Number(r.value); setDisabled(next1, false); }
            });
          });
        } catch (err) {
          plansGrid.innerHTML = '<div class="text-red-400">Error cargando planes</div>';
        }
      }

      qs("#reg-next1").addEventListener("click", () => {
        if (!selectedPlanId) { toast("Selecciona un plan", "err"); return; }
        setStep(2);
      });
      qs("#reg-back1").addEventListener("click", () => setStep(1));

      // Campos registro
      const nombre = qs("#reg-nombre");
      const apellido = qs("#reg-apellido");
      const correo = qs("#reg-correo");
      const telefono = qs("#reg-telefono");
      const direccion = qs("#reg-direccion");
      const ciudad = qs("#reg-ciudad");
      const rol = qs("#reg-rol");
      const hospCodigo = qs("#reg-hospital-codigo");
      const pass1 = qs("#reg-password");
      const pass2 = qs("#reg-password2");
      const next2 = qs("#reg-next2");

      function validateRegisterUI() {
        const okNombre = nombre.value.trim().length >= 2;
        const okApellido = apellido.value.trim().length >= 2;
        const okCorreo = validateEmail(correo.value);
        const okTel = validatePhone(telefono.value.trim());
        const okHospCodFormat = validateHospCodigo(hospCodigo.value.trim()); // opcional
        const okPwd = validatePwd(pass1.value).ok;
        const okMatch = pass1.value !== "" && pass1.value === pass2.value;

        show(qs("#err-nombre"), !okNombre && nombre.value !== "");
        show(qs("#err-apellido"), !okApellido && apellido.value !== "");
        show(qs("#err-correo"), !okCorreo && correo.value !== "");
        show(qs("#err-telefono"), !okTel && telefono.value !== "");
        show(qs("#err-pass"), !okPwd && pass1.value !== "");
        show(qs("#err-pass2"), !okMatch && pass2.value !== "");

        const allOk = okNombre && okApellido && okCorreo && okTel && okPwd && okMatch && okHospCodFormat;
        setDisabled(next2, !allOk);
        return allOk;
      }

      let LAST_REG_PAYLOAD = null;
      async function preRegister() {
        const payload = {
          nombre: nombre.value.trim(),
          apellido: apellido.value.trim(),
          correo: correo.value.trim(),
          password: pass1.value,
          rol: rol.value,
          telefono: telefono.value.trim() || null,
          direccion: direccion.value.trim() || null,
          ciudad: ciudad.value.trim() || null,
        };
        LAST_REG_PAYLOAD = payload;

        // Si hay token, validar que sea del mismo correo
        const existing = localStorage.getItem('jwt') || TOKEN;
        if (existing) {
          try { const me = await api('/auth/me'); if (me?.correo?.toLowerCase() === payload.correo.toLowerCase()) return true; } catch {}
          localStorage.removeItem('jwt'); TOKEN = null;
        }

        const res = await api('/auth/pre-register', { method: 'POST', body: payload });
        qs('#verify-to').textContent = 'Enviado a: ' + payload.correo;
        return !!res?.ok;
      }

      async function tryLoginAfterVerify() {
        if (!LAST_REG_PAYLOAD) return false;
        const { correo: c, password: p } = LAST_REG_PAYLOAD;
        const r = await api('/auth/login', { method: 'POST', body: { correo: c, password: p } });
        TOKEN = r.access_token; localStorage.setItem('jwt', TOKEN);
        try { const me = await api('/auth/me'); localStorage.setItem('user', JSON.stringify(me)); } catch {}
        return true;
      }

      async function proceedToPayment() {
        const code = (hospCodigo.value || '').trim();

        if (code) {
          try {
            await api('/hospitals/link-by-code', { method: 'POST', body: { codigo: code } });
            toast('Vinculado al hospital.', 'ok');
          } catch (err) {
            if (err?.status === 404) toast('Código inválido o inactivo.', 'err');
            else if (err?.status === 403) toast('Solo disponible para médicos.', 'err');
            else if (err?.status === 401) {
              toast('Sesión inválida, inicia sesión.', 'err');
              localStorage.removeItem('jwt');
              setTab('login');
              return;
            } else {
              toast('No fue posible vincular el hospital.', 'err');
            }
          }
        }

        const out = await api('/subscriptions/start', { method: 'POST', body: { plan_id: selectedPlanId } });

        // limpiar e inyectar script de ePayco
        const form = qs('#epayco-form');
        form.innerHTML = '';

        const s = document.createElement('script');
        s.src = 'https://checkout.epayco.co/checkout.js';
        s.className = 'epayco-button';

        s.setAttribute('data-epayco-key', out.checkout.key);
        s.setAttribute('data-epayco-amount', out.checkout.amount);
        s.setAttribute('data-epayco-tax', '0.00');
        s.setAttribute('data-epayco-tax-ico', '0.00');
        s.setAttribute('data-epayco-tax-base', out.checkout.amount);
        s.setAttribute('data-epayco-name', out.checkout.name);
        s.setAttribute('data-epayco-description', out.checkout.description);
        s.setAttribute('data-epayco-currency', out.checkout.currency);
        s.setAttribute('data-epayco-country', 'CO');
        s.setAttribute('data-epayco-test', String(!!out.checkout.test));
        s.setAttribute('data-epayco-external', 'true');

        const frontResp = location.origin + (location.pathname.replace(/\/[^/]*$/, '/')) + 'epayco_result.html';
        s.setAttribute('data-epayco-response', frontResp);
        s.setAttribute('data-epayco-confirmation', out.checkout.confirmation);
        s.setAttribute('data-epayco-invoice', out.checkout.invoice);
        s.setAttribute('data-epayco-extra1', out.checkout.extra1);
        s.setAttribute('data-epayco-button', 'https://multimedia.epayco.co/dashboard/btns/btn3.png');

        form.appendChild(s);

        // Evitar botones duplicados que pueda inyectar ePayco
        const cleanup = () => document.querySelectorAll('.btn-epayco').forEach(el => el.remove());
        cleanup();
        new MutationObserver(cleanup).observe(form.parentElement, { childList: true, subtree: true });

        setStep(4);
      }

      [nombre, apellido, correo, telefono, pass1, pass2, hospCodigo, rol, direccion, ciudad].forEach((el) => {
        el.addEventListener("input", () => { if (el === pass1) setPwdMeter(pass1.value); validateRegisterUI(); });
      });
      setPwdMeter("");

      qs('#reg-next2').addEventListener('click', async () => {
        if (!validateRegisterUI()) { toast('Revisa los datos del formulario', 'err'); return; }
        setDisabled(next2, true);
        try {
          await preRegister();
          setStep(3);
          toast('Te enviamos un correo de verificación', 'ok');
        } catch (err) {
          toast('Error enviando verificación: ' + (err?.data?.detail || err.status || err?.message), 'err');
        } finally { setDisabled(next2, false); }
      });

      qs('#verify-resend').addEventListener('click', async () => {
        try { await preRegister(); toast('Correo reenviado', 'ok'); }
        catch { toast('Falló el reenvío', 'err'); }
      });

      qs('#verify-continue').addEventListener('click', async () => {
        try { await tryLoginAfterVerify(); }
        catch { toast('Aún no está verificado. Revisa tu correo.', 'err'); return; }
        try { await proceedToPayment(); }
        catch { toast('Error preparando pago', 'err'); }
      });

      // Navegación “Atrás”
      qs('#reg-back1').addEventListener('click', () => setStep(1)); // desde 2 → 1
      qs('#reg-back2').addEventListener('click', () => setStep(2)); // desde 3 → 2
      qs('#reg-back3').addEventListener('click', () => setStep(3)); // desde 4 → 3

      // Estado inicial
      function init() { validateLoginUI(); validateRegisterUI(); }
      init();

      // ---- Enhancements: code-based email verification + forgot password ----
      // Email uniqueness check (inline alert + disable next)
      (function setupEmailUniq(){
        const input = qs('#reg-correo');
        if (!input) return;
        // Create inline error element if missing
        let err = document.getElementById('err-correo-exists');
        if (!err) {
          err = document.createElement('small');
          err.id = 'err-correo-exists';
          err.className = 'hint text-red-400 hidden';
          err.textContent = 'Este correo ya está registrado.';
          const label = input.closest('label');
          (label || input.parentElement).appendChild(err);
        }
        let lastChecked = '';
        let existsFlag = false;
        async function check(){
          const v = (input.value || '').trim();
          if (!validateEmail(v)) { err.classList.add('hidden'); existsFlag = false; return; }
          if (v === lastChecked) return;
          lastChecked = v;
          try {
            const r = await api('/auth/email-exists?correo=' + encodeURIComponent(v));
            existsFlag = !!r?.exists;
            if (existsFlag) { err.classList.remove('hidden'); } else { err.classList.add('hidden'); }
          } catch { /* ignore */ }
          // If exists, ensure Next disabled
          const next2Btn = qs('#reg-next2');
          if (next2Btn) setDisabled(next2Btn, existsFlag || next2Btn.disabled);
        }
        input.addEventListener('blur', check);
        input.addEventListener('input', () => { err.classList.add('hidden'); });
        // Guard on Next click: block and alert
        const next2Btn = qs('#reg-next2');
        next2Btn && next2Btn.addEventListener('click', async (e) => {
          await check();
          if (existsFlag) { e.preventDefault(); toast('Ese correo ya está registrado', 'err'); }
        }, { capture: true });
      })();
      // Capture pre-register token from API responses
      (function patchApiForPreRegister(){
        const _api = api;
        window.PRE_TOKEN = null;
        api = async function(path, opts){
          const data = await _api(path, opts);
          try {
            if (String(path) === '/auth/pre-register' && data && data.token) {
              window.PRE_TOKEN = data.token;
            }
          } catch {}
          return data;
        }
      })();

      function ensureCodeUI(){
        try {
          const step = qs('#reg-step3'); if (!step) return;
          const info = step.querySelector('p.text-gray-300');
          if (info) info.innerHTML = 'Te enviamos un correo con un <b>codigo de 6 digitos</b>. Escribelo a continuacion.';
          let codeInput = qs('#verify-code');
          if (!codeInput) {
            const wrap = document.createElement('div');
            wrap.className = 'max-w-sm mx-auto mt-4 flex items-center gap-2';
            wrap.innerHTML = "<input id=\"verify-code\" inputmode=\"numeric\" pattern=\"^[0-9]{6}$\" maxlength=\"6\" placeholder=\"000000\" class=\"flex-1 py-3 px-3 text-center tracking-widest bg-black border border-gray-700 rounded-lg\" />";
            const after = step.querySelector('#verify-to') || info;
            if (after) after.insertAdjacentElement('afterend', wrap);
          }
          // Replace existing click handlers on 'verify-continue'
          const oldBtn = qs('#verify-continue');
          if (oldBtn) {
            const newBtn = oldBtn.cloneNode(true);
            newBtn.textContent = 'Verificar';
            oldBtn.parentNode.replaceChild(newBtn, oldBtn);
            newBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              const code = (qs('#verify-code')?.value || '').trim();
              if (!/^[0-9]{6}$/.test(code)) { toast('Codigo invalido', 'err'); return; }
              if (!window.PRE_TOKEN) { toast('Sesion de verificacion no iniciada', 'err'); return; }
              try { await api('/auth/register/confirm-code', { method: 'POST', body: { token: window.PRE_TOKEN, code } }); }
              catch { toast('Codigo invalido o expirado', 'err'); return; }
              try { await tryLoginAfterVerify(); }
              catch { toast('No fue posible iniciar sesion tras verificar', 'err'); return; }
              try { await proceedToPayment(); }
              catch { toast('Error preparando pago', 'err'); }
            });
          }
        } catch {}
      }

      // Hard guard: verify email uniqueness before entering step 3
      (function hardGuardEmailBeforeStep3(){
        const btn = document.getElementById('reg-next2');
        const input = document.getElementById('reg-correo');
        if (!btn || !input) return;
        btn.addEventListener('click', async (e) => {
          try {
            const v = (input.value || '').trim();
            if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)) return;
            const r = await api('/auth/email-exists?correo=' + encodeURIComponent(v));
            if (r?.exists) { e.preventDefault(); e.stopImmediatePropagation(); toast('Ese correo ya esta registrado', 'err'); }
          } catch {}
        }, { capture: true });
      })();

      // When moving to step 3, ensure code UI is present
      const btnNext2 = qs('#reg-next2');
      if (btnNext2) btnNext2.addEventListener('click', () => setTimeout(ensureCodeUI, 80));
      // Also on resend
      const btnResend = qs('#verify-resend');
      if (btnResend) btnResend.addEventListener('click', () => setTimeout(ensureCodeUI, 50));

      // Forgot password: create simple box on demand
      function createForgotBox(){
        if (qs('#forgot-box')) return qs('#forgot-box');
        const wrap = document.createElement('div');
        wrap.id = 'forgot-box';
        wrap.className = 'mt-4';
        wrap.innerHTML = `
          <div class="p-4 rounded-xl bg-gray-800 border border-gray-700">
            <h3 class="font-semibold mb-2">Recuperar contrasena</h3>
            <div class="flex gap-2">
              <input id="forgot-email" type="email" placeholder="tu@correo.com" class="flex-1 py-2 px-3 bg-black border border-gray-700 rounded-lg" />
              <button id="forgot-send" class="px-4 py-2 rounded-lg bg-cyan-500 text-black font-semibold">Enviar</button>
            </div>
            <p class="hint text-gray-400 mt-2">Te enviaremos un enlace para restablecer tu contrasena.</p>
          </div>`;
        const formLogin = qs('#form-login');
        formLogin && formLogin.insertAdjacentElement('afterend', wrap);
        qs('#forgot-send')?.addEventListener('click', async () => {
          const em = (qs('#forgot-email')?.value || '').trim();
          if (!validateEmail(em)) { toast('Correo invalido', 'err'); return; }
          try { await api('/auth/forgot-password', { method: 'POST', body: { correo: em } }); toast('Revisa tu correo para restablecer', 'ok'); }
          catch { toast('No fue posible enviar el correo', 'err'); }
        });
        return wrap;
      }
      // Link handler -> redirige a página dedicada de reset
      (function attachForgot(){
        const a = qs('#panel-login a.text-center') || document.querySelector('#panel-login a[href="#"]');
        if (a) a.setAttribute('href', 'reset_password.html');
      })();
    </script>
  </body>
</html>
